name: ğŸ”„ CI

on:
  push:
    branches:
      - main
  pull_request: {}

permissions:
  actions: write
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  lint:
    name: â¬£ ESLint
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ“¥ Install pnpm
        uses: pnpm/action-setup@v2.2.4

      - name: ğŸ“¥ Use Node.js from .nvmrc
        uses: actions/setup-node@v3
        with:
          cache: "pnpm"
          node-version-file: ".nvmrc"

      - name: ğŸ“¥ Install via pnpm
        run: pnpm install
        shell: bash

      - name: ğŸ”¬ Lint
        run: pnpm run lint

  prettier:
    name: ğŸ” Prettier
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ“¥ Install pnpm
        uses: pnpm/action-setup@v2.2.4

      - name: ğŸ“¥ Use Node.js from .nvmrc
        uses: actions/setup-node@v3
        with:
          cache: "pnpm"
          node-version-file: ".nvmrc"

      - name: ğŸ“¥ Install via pnpm
        run: pnpm install
        shell: bash

      - name: â¤ï¸ Run format:check
        run: pnpm run format:check

  test:
    name: âš¡ Test
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ“¥ Install pnpm
        uses: pnpm/action-setup@v2.2.4

      - name: ğŸ“¥ Use Node.js from .nvmrc
        uses: actions/setup-node@v3
        with:
          cache: "pnpm"
          node-version-file: ".nvmrc"

      - name: ğŸ“¥ Install via pnpm
        run: pnpm install
        shell: bash

      - name: âš¡ Run tests
        run: pnpm run test

  integration-test:
    name: âš¡ Integration Test
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ“¥ Install pnpm
        uses: pnpm/action-setup@v2.2.4

      - name: ğŸ“¥ Use Node.js from .nvmrc
        uses: actions/setup-node@v3
        with:
          cache: "pnpm"
          node-version-file: ".nvmrc"

      - name: ğŸ“¥ Install via pnpm
        run: pnpm install
        shell: bash

      - name: ğŸ  Run build
        run: pnpm run build

      - name: âš¡ Run integration tests
        uses: ./
        with:
          dryRun: true
          slackWebhook: "invalid-slack-webhook"
          additionalPlaceholders: |
            non-production=https://google.com
          message: ":rocket: A new [[@linkify(it.links.commitSha, 'version') /]] of [[@linkify(it.links.repository, it.repository) /]] has been deployed to [[@linkify(it['non-production'], 'non-production') /]]!"

  release:
    name: ğŸš€ Release
    runs-on: ubuntu-latest
    needs: [lint, prettier, test, integration-test]
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3
        with:
          # This makes Actions fetch all Git history so that release-it can generate changelogs with the correct commits
          fetch-depth: 0

      - name: ğŸ“¥ Install pnpm
        uses: pnpm/action-setup@v2.2.4

      - name: ğŸ“¥ Use Node.js from .nvmrc
        uses: actions/setup-node@v3
        with:
          cache: "pnpm"
          node-version-file: ".nvmrc"

      - name: ğŸ“¥ Install via pnpm
        run: pnpm install
        shell: bash

      - name: ğŸš€ Semantic Release
        run: pnpm dlx semantic-release
        env:
          GH_TOKEN: ${{ secrets.TAG_PAT }}
          GITHUB_TOKEN: ${{ secrets.TAG_PAT }}
